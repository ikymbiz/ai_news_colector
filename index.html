<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News - Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-navy-dark { background-color: #020617; } /* Slate-950 */
        .is-topic { border-left: 4px solid #2563eb; background-color: #f8fafc; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .tag-badge { font-size: 9px; font-weight: 700; background-color: #f1f5f9; color: #64748b; padding: 1px 6px; border-radius: 3px; border: 1px solid #e2e8f0; }
        .important-box { background-color: #fdfaf6; border: 1px solid #fee2e2; border-radius: 6px; padding: 10px; margin-top: 12px; font-size: 0.8rem; color: #451a03; }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        #settings-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; overflow-y: auto; background-color: #f8fafc; }
        #settings-screen.active { display: block; }

        @keyframes pulse-dot { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .pulse-live { animation: pulse-dot 2s infinite; }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen font-sans text-slate-900 antialiased">

<div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-[200] bg-slate-900 text-white px-5 py-2 rounded-lg shadow-2xl text-xs font-bold border border-slate-700"></div>

<div id="configModal" class="modal p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 border border-slate-200">
        <h2 class="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">ğŸ”Œ Firebase Connection</h2>
        <textarea id="configInput" rows="6" class="w-full border border-slate-200 rounded-lg p-3 text-xs font-mono mb-4 bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500" placeholder='NC_v1_... ã¾ãŸã¯ raw config'></textarea>
        <div class="flex gap-2">
            <button id="saveConfigBtn" class="flex-grow bg-slate-950 text-white font-bold py-2 rounded-lg hover:bg-black transition text-sm">è¨­å®šã‚’ä¿å­˜</button>
            <button id="closeModalBtn" class="px-4 py-2 text-slate-400 font-bold text-sm">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="modal p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-8 border border-slate-200 text-center">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
        <p class="text-xs text-slate-400 mb-8 leading-relaxed">ã“ã®è¨˜äº‹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰éè¡¨ç¤ºã«ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
        <div class="flex flex-col gap-2">
            <button id="executeDeleteBtn" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition">å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹</button>
            <button id="cancelDeleteBtn" class="w-full py-3 text-slate-400 font-bold text-sm hover:text-slate-600 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="news-screen">
    <header class="bg-navy-dark py-5 px-4 md:px-8 text-white shadow-xl">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold tracking-tight">AI News <span class="text-blue-400 font-black">Database</span></h1>
                <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.3em] mt-0.5">INTELLIGENT NEWS ARCHIVE</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettings()" class="p-2 bg-slate-900 hover:bg-slate-800 rounded transition border border-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z" /></svg>
                </button>
                <button id="statusBadge" class="px-3 py-1 rounded border border-slate-800 text-[9px] font-black bg-slate-900 text-slate-500 tracking-widest transition-all">
                    OFFLINE
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto p-4">
        <div class="bg-white p-2 rounded-lg shadow-sm mb-5 flex gap-3 items-center border border-slate-200">
            <input type="text" id="searchBox" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." class="flex-grow bg-transparent border-none px-3 py-1 text-sm outline-none placeholder:text-slate-300">
            <label class="flex items-center gap-2 px-3 py-1 text-[11px] text-slate-500 font-bold border-l border-slate-100 cursor-pointer">
                <input type="checkbox" id="topicOnly" class="w-3.5 h-3.5 rounded text-blue-600 border-slate-300" checked> ãƒˆãƒ”ãƒƒã‚¯ã®ã¿
            </label>
        </div>

        <div id="articles-container" class="space-y-4">
            <div class="text-center py-20 text-slate-300 text-sm italic animate-pulse font-medium">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div id="sentinel" class="py-12 flex flex-col items-center justify-center gap-3">
            <div id="loader-spinner" class="w-5 h-5 border-2 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>
            <span id="loader-text" class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em]">Synchronizing Database</span>
            <div class="mt-1 text-[9px] font-bold text-slate-300 tracking-[0.1em] uppercase">
                Â© AI News Database, 2026
            </div>
        </div>
    </div>
</div>

<div id="settings-screen">
    <div class="max-w-4xl mx-auto p-6 md:p-10">
        <div class="flex justify-between items-center mb-8 pb-4 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-800 italic uppercase tracking-tighter">System Settings</h2>
            <button onclick="closeSettings()" class="px-5 py-2 bg-slate-950 text-white rounded-lg font-bold text-xs hover:bg-black transition">æˆ»ã‚‹</button>
        </div>

        <div class="mb-8 bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
            <h3 class="text-xs font-black text-slate-400 mb-5 uppercase tracking-widest italic">ğŸš€ System Actions</h3>
            <div class="flex items-center gap-4">
                <button id="execButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-700 transition">
                    GCSåŒæœŸã‚’å®Ÿè¡Œ
                </button>
                <span id="result" class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">Ready</span>
            </div>
            <p class="mt-2 text-[9px] text-slate-400 leading-relaxed">
                Firestoreã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦Google Cloud Storageã¸ä¿å­˜ã—ã¾ã™ã€‚
            </p>
        </div>

        <div class="mb-8 bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
            <h3 class="text-xs font-black text-slate-400 mb-5 uppercase tracking-widest italic">ğŸ“° Feed Management</h3>
            <div id="rss-list" class="space-y-2"></div>
            <div class="mt-6 flex justify-between items-center">
                <button onclick="addFeedRow()" class="text-[10px] font-bold text-blue-600 hover:underline">ï¼‹ æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ </button>
                <button onclick="saveAllRss()" class="px-5 py-2 bg-slate-900 text-white rounded font-bold text-[10px]">ä¿å­˜</button>
            </div>
        </div>

        <div class="mb-8 bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
            <h3 class="text-xs font-black text-slate-400 mb-5 uppercase tracking-widest italic">ğŸ§  AI Orchestration</h3>
            <div class="mb-6 pb-6 border-b border-slate-50">
                <label class="text-[10px] font-bold text-slate-800 block mb-2 uppercase tracking-tighter">Default System Model</label>
                <div class="flex gap-2">
                    <input id="root-model" type="text" placeholder="e.g. gpt-4o-mini" class="flex-grow bg-slate-50 border border-slate-200 rounded px-3 py-2 text-xs font-mono outline-none">
                    <button onclick="saveRootModel()" class="px-4 py-2 bg-slate-800 text-white rounded font-bold text-[10px]">ä¿å­˜</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-bold uppercase">Skip Categories</span><button onclick="saveList('skip_categories')" class="text-[10px] text-blue-600 font-bold">SAVE</button></div>
                    <textarea id="list-skip_categories" rows="4" class="w-full border border-slate-200 rounded p-2 text-[10px] font-mono bg-slate-50 outline-none focus:ring-1 focus:ring-blue-100"></textarea>
                </div>
                <div>
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-bold uppercase">Skip Feeds</span><button onclick="saveList('skip_feeds')" class="text-[10px] text-blue-600 font-bold">SAVE</button></div>
                    <textarea id="list-skip_feeds" rows="4" class="w-full border border-slate-200 rounded p-2 text-[10px] font-mono bg-slate-50 outline-none focus:ring-1 focus:ring-blue-100"></textarea>
                </div>
                <div>
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-bold uppercase">Override Tags</span><button onclick="saveList('override_categories')" class="text-[10px] text-blue-600 font-bold">SAVE</button></div>
                    <textarea id="list-override_categories" rows="4" class="w-full border border-slate-200 rounded p-2 text-[10px] font-mono bg-slate-50 outline-none focus:ring-1 focus:ring-blue-100"></textarea>
                </div>
            </div>
        </div>
        <div id="prompts-container" class="space-y-4"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { initializeFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    let db = null;
    let allArticles = [];
    let pendingDeleteId = null;
    let currentLimit = 30;
    let unsubscribe = null;
    let isFetching = false;
    let hasMore = true;

    const modal = document.getElementById('configModal');
    const deleteModal = document.getElementById('deleteConfirmModal');
    const container = document.getElementById('articles-container');
    const statusBadge = document.getElementById('statusBadge');
    const rssList = document.getElementById('rss-list');
    const promptsContainer = document.getElementById('prompts-container');
    const loaderSpinner = document.getElementById('loader-spinner');
    const loaderText = document.getElementById('loader-text');

    const showToast = (msg) => {
        const t = document.getElementById('toast'); t.innerText = msg;
        t.classList.replace('translate-y-20', 'translate-y-0'); t.classList.replace('opacity-0', 'opacity-100');
        setTimeout(() => { t.classList.replace('translate-y-0', 'translate-y-20'); t.classList.replace('opacity-100', 'opacity-0'); }, 3000);
    };

    window.openSettings = () => {
        document.getElementById('news-screen').style.display = 'none';
        document.getElementById('settings-screen').classList.add('active');
        loadSettings();
    };
    window.closeSettings = () => {
        document.getElementById('news-screen').style.display = 'block';
        document.getElementById('settings-screen').classList.remove('active');
    };

    window.toggleRelated = (id) => {
        const content = document.getElementById(`related-content-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);
        if (content) { content.classList.toggle('hidden'); arrow.classList.toggle('rotate-180'); }
    };

    window.toggleInsight = (id) => {
        const content = document.getElementById(`insight-content-${id}`);
        const arrow = document.getElementById(`insight-arrow-${id}`);
        if (content) { content.classList.toggle('hidden'); arrow.classList.toggle('rotate-180'); }
    };

    const decodeToken = (token) => {
        if (!token || !token.startsWith("NC_v1_")) return token;
        try {
            const rawBody = token.replace("NC_v1_", "");
            const reversed = rawBody.split('').reverse().join('');
            return decodeURIComponent(escape(atob(reversed)));
        } catch (e) { return token; }
    };

    const sanitizeJsonString = (s) => {
        if (!s) return "";
        let t = String(s).trim();
        if (t.startsWith("```")) {
            t = t.replace(/^```[a-zA-Z]*\s*/m, "").replace(/```$/m, "").trim();
        }
        return t;
    };

    const initApp = () => {
        const stored = localStorage.getItem('firebase_config');
        if (!stored) { modal.style.display = 'flex'; return; }
        const raw = decodeToken(stored);
        try {
            const extract = (k) => {
                const reg = new RegExp(`${k}\\s*[:=]\\s*["'\`]([^"'\`\\s,]+)["'\`]`);
                const m = raw.match(reg); return m ? m[1] : null;
            };
            const config = {
                apiKey: extract('apiKey'), authDomain: extract('authDomain'), projectId: extract('projectId'),
                storageBucket: extract('storageBucket'), messagingSenderId: extract('messagingSenderId'), appId: extract('appId')
            };
            const app = initializeApp(config);
            db = initializeFirestore(app, { ignoreUndefinedProperties: true });
            statusBadge.innerText = 'â— LIVE';
            statusBadge.className = 'px-3 py-1 rounded border border-blue-500/50 text-[9px] font-black bg-blue-500/10 text-blue-400 tracking-widest pulse-live cursor-pointer uppercase';

            startListening();
            initInfiniteScroll();
        } catch (e) { statusBadge.innerText = 'ERROR'; modal.style.display = 'flex'; }
    };

    const startListening = () => {
        if (unsubscribe) unsubscribe();
        const q = query(collection(db, "articles"), orderBy("published_at", "desc"), limit(currentLimit));

        unsubscribe = onSnapshot(q, (snapshot) => {
            const docs = snapshot.docs;
            hasMore = docs.length >= currentLimit;
            
            if (!hasMore) {
                loaderSpinner.style.display = 'none';
                loaderText.innerText = "End of Database";
            }

            allArticles = docs.map(d => {
                const data = d.data();
                let categories = [];
                let rawCategory = data.category;

                if (Array.isArray(rawCategory)) categories = rawCategory;
                else if (typeof rawCategory === 'string') {
                    const trimmed = rawCategory.trim();
                    if (trimmed.startsWith('{')) {
                        try {
                            const parsed = JSON.parse(trimmed);
                            categories = parsed.category || parsed.categories || [];
                        } catch (e) { categories = [trimmed]; }
                    } else if (trimmed !== "") {
                        categories = trimmed.split(/[,ã€\s]+/).map(c => c.trim());
                    }
                }

                const rawImp = sanitizeJsonString((data.important || "").trim());
                let impInfo = null; if (rawImp.startsWith('{')) { try { impInfo = JSON.parse(rawImp); } catch(e) {} }

                const rawRelated = sanitizeJsonString((data.related || "").trim());
                let relatedInfo = null; if (rawRelated.startsWith('[')) { try { relatedInfo = JSON.parse(rawRelated); } catch(e) {} }

                return {
                    id: d.id, ...data,
                    title: (data.title || "Untitled").replace(/<[^>]*>?/gm, ''),
                    displaySummary: (data.summary || data.report || data.body || "").replace(/<[^>]*>?/gm, ''),
                    category: Array.isArray(categories) ? categories : [categories],
                    importantInfo: impInfo,
                    relatedInfo: relatedInfo,
                    is_deleted: data.is_deleted || false,
                    is_topic: data.is_topic || false
                };
            }).filter(d => !d.is_deleted);

            renderArticles();
            isFetching = false;
        });
    };

    const initInfiniteScroll = () => {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isFetching && hasMore) {
                isFetching = true; currentLimit += 30; startListening();
            }
        }, { threshold: 0.1, rootMargin: '100px' });
        observer.observe(document.getElementById('sentinel'));
    };

    const renderArticles = () => {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        const topicOnly = document.getElementById('topicOnly').checked;
        const filtered = allArticles.filter(a => {
            const searchTargets = (a.title + a.displaySummary + a.category.join('') + (a.report || "")).toLowerCase();
            return searchTargets.includes(searchTerm) && (topicOnly ? a.is_topic : true);
        });

        if (filtered.length === 0) {
            container.innerHTML = `<div class="py-20 text-center text-slate-300 text-xs tracking-widest uppercase italic font-bold">No Records Found</div>`;
            return;
        }

        container.innerHTML = filtered.map(a => {
            let domain = ""; try { domain = new URL(a.url).hostname; } catch(e) {}
            let importantHtml = "";
            if (a.importantInfo && a.importantInfo.flag) {
                const detail = a.importantInfo.articles?.[0] || {};
                importantHtml = `<div class="important-box">
                    <div class="font-bold leading-snug text-slate-900 text-xs mb-1 tracking-tight">ğŸ“Œ ${detail.extraction_reason || 'AIè¦ç´„ã‚ã‚Š'}</div>
                </div>`;
            }

            let reportHtml = "";
            const reportText = (a.report || "").trim();
            if (a.is_topic && reportText) {
                reportHtml = `
                    <div class="mt-4 border border-amber-200 rounded-lg overflow-hidden bg-amber-50/60">
                        <button onclick="window.toggleInsight('${a.id}')" class="w-full flex justify-between items-center px-4 py-2.5 hover:bg-amber-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black text-amber-700 uppercase tracking-widest italic">Strategic Insight</span>
                                <span class="bg-amber-200/60 text-amber-800 text-[8px] font-bold px-1.5 rounded-full">REPORT</span>
                            </div>
                            <svg id="insight-arrow-${a.id}" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-3 w-3 text-amber-700/60 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="insight-content-${a.id}" class="hidden px-4 pb-4 pt-2 bg-white border-t border-amber-100 text-[11px] text-slate-700 leading-relaxed whitespace-pre-line">${reportText.replace(/</g, "&lt;")}</div>
                    </div>`;
            }

            let relatedHtml = "";
            if (a.relatedInfo && Array.isArray(a.relatedInfo) && a.relatedInfo.length > 0) {
                const links = a.relatedInfo.map(rel => `
                    <li class="mb-3 last:mb-0 pb-3 border-b border-slate-100 last:border-0 group">
                        <a href="${rel.URL}" target="_blank" class="flex items-start gap-2 text-blue-600 font-bold hover:text-blue-800 transition-colors block mb-1 tracking-tight">
                            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-4 w-4 mt-0.5 flex-shrink-0 text-blue-400 group-hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            <span class="text-[11px] leading-tight">${rel.è¦‹å‡ºã—}</span>
                        </a>
                        <p class="text-[10px] text-slate-500 leading-relaxed pl-6">${rel.å†…å®¹}</p>
                    </li>`).join('');

                relatedHtml = `
                    <div class="mt-4 border border-slate-200 rounded-lg overflow-hidden bg-slate-50/50">
                        <button onclick="window.toggleRelated('${a.id}')" class="w-full flex justify-between items-center px-4 py-2.5 hover:bg-slate-100 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest italic">Related Intelligence</span>
                                <span class="bg-blue-100 text-blue-600 text-[8px] font-bold px-1.5 rounded-full">${a.relatedInfo.length}</span>
                            </div>
                            <svg id="arrow-${a.id}" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-3 w-3 text-slate-400 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="related-content-${a.id}" class="hidden px-4 pb-4 pt-1 bg-white border-t border-slate-100"><ul class="list-none m-0">${links}</ul></div>
                    </div>`;
            }

            return `
            <article class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden ${a.is_topic ? 'is-topic' : ''}">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-black text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded tracking-widest uppercase">${a.source || 'FEED'}</span>
                            <span class="text-[9px] text-slate-300 font-bold italic tracking-tight">${domain}</span>
                        </div>
                        <span class="text-[9px] text-slate-400 font-bold">${a.published_at ? new Date(a.published_at.seconds * 1000).toLocaleDateString('ja-JP') : ''}</span>
                    </div>
                    <h2 class="text-base font-bold text-slate-900 mb-1.5 leading-snug tracking-tight">
                        <a href="${a.url}" target="_blank" class="hover:text-blue-600 transition-colors">${a.title}</a>
                    </h2>
                    <p class="text-slate-500 text-[11px] mb-3 leading-relaxed line-clamp-2 font-medium">${a.displaySummary}</p>
                    <div class="flex flex-wrap gap-1.5 mb-2">${a.category.map(cat => `<span onclick="window.setSearchTerm('${cat}')" class="tag-badge cursor-pointer hover:bg-blue-100 hover:text-blue-600 transition-colors">#${cat}</span>`).join('')}</div>
                    ${importantHtml} ${reportHtml} ${relatedHtml}
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-50">
                        <div class="flex gap-4">
                            <button onclick="window.updateTopic('${a.id}', ${a.is_topic})" class="text-[9px] font-bold tracking-widest ${a.is_topic ? 'text-blue-600' : 'text-slate-300 hover:text-slate-500'}">${a.is_topic ? 'â˜… TOPIC' : 'â˜† MARK'}</button>
                            <button onclick="window.confirmDelete('${a.id}')" class="text-[9px] font-bold text-slate-200 hover:text-red-400 uppercase tracking-widest">Delete</button>
                        </div>
                    </div>
                </div>
            </article>`;
        }).join('');
    };

    window.setSearchTerm = (term) => {
        const searchBox = document.getElementById('searchBox');
        searchBox.value = term;
        document.getElementById('topicOnly').checked = false;
        renderArticles();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.updateTopic = async (id, current) => {
        await updateDoc(doc(db, "articles", id), { is_topic: !current, updated_at: serverTimestamp() });
    };

    window.confirmDelete = (id) => { pendingDeleteId = id; deleteModal.style.display = 'flex'; };
    document.getElementById('cancelDeleteBtn').onclick = () => { deleteModal.style.display = 'none'; };
    document.getElementById('executeDeleteBtn').onclick = async () => {
        if (pendingDeleteId && db) {
            await updateDoc(doc(db, "articles", pendingDeleteId), { is_deleted: true, updated_at: serverTimestamp() });
            showToast("è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
        }
        deleteModal.style.display = 'none';
    };

    window.loadSettings = async () => {
        if (!db) return;
        try {
            const [promptSnap, rssSnap] = await Promise.all([
                getDoc(doc(db, "configs", "prompt")),
                getDoc(doc(db, "configs", "rss_sources"))
            ]);
            if (rssSnap.exists()) {
                rssList.innerHTML = '';
                (rssSnap.data().feeds || []).forEach(f => addFeedRow(f.name, f.url));
            }
            if (promptSnap.exists()) {
                const data = promptSnap.data();
                if(document.getElementById('root-model')) document.getElementById('root-model').value = data.model || '';
                ['skip_categories', 'skip_feeds', 'override_categories'].forEach(key => {
                    const el = document.getElementById(`list-${key}`);
                    if (el) el.value = (data[key] || []).join('\n');
                });
                promptsContainer.innerHTML = '';
                const sections = ["is_AI","category","important","summary","related","report","mail_summary","ai_filter"];
                sections.forEach(name => {
                    const cfg = data[name] || {};
                    promptsContainer.insertAdjacentHTML('beforeend', `
                        <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-slate-800 text-[10px] uppercase tracking-widest italic">${name}</h4>
                                <button onclick="savePrompt('${name}')" class="px-3 py-1 bg-slate-950 text-white text-[9px] font-bold rounded hover:bg-black transition">SAVE ALL</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-[8px] font-black text-slate-400 uppercase mb-1 block">Model Override</label><input id="model-${name}" type="text" value="${cfg.model || ''}" placeholder="Default" class="w-full bg-slate-50 border border-slate-100 rounded px-2 py-1.5 text-[10px] font-mono outline-none"></div>
                                <div><label class="text-[8px] font-black text-slate-400 uppercase mb-1 block">Temperature</label><input id="temp-${name}" type="number" step="0.1" min="0" max="2" value="${cfg.temperature ?? 0.2}" class="w-full bg-slate-50 border border-slate-100 rounded px-2 py-1.5 text-[10px] font-mono outline-none"></div>
                            </div>
                            <label class="text-[8px] font-black text-slate-400 uppercase mb-1 block">System Instruction</label>
                            <textarea id="prompt-${name}" rows="5" class="w-full border-none rounded-lg p-3 text-[11px] text-slate-600 bg-slate-50 outline-none leading-relaxed">${cfg.prompt || ''}</textarea>
                        </div>`);
                });
            }
        } catch (e) { showToast("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    };

    window.addFeedRow = (name = "", url = "") => {
        const div = document.createElement('div');
        div.className = "flex gap-2 p-2 bg-slate-50 border border-slate-100 rounded";
        div.innerHTML = `<input type="text" name="f-name" value="${name}" placeholder="Name" class="flex-1 border-none rounded px-2 py-1.5 text-[11px] outline-none shadow-sm"><input type="url" name="f-url" value="${url}" placeholder="URL" class="flex-[2] border-none rounded px-2 py-1.5 text-[11px] font-mono outline-none shadow-sm"><button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 px-1 text-xs">âœ•</button>`;
        rssList.appendChild(div);
    };

    window.saveAllRss = async () => {
        const feeds = Array.from(rssList.querySelectorAll('div')).map(row => ({
            name: row.querySelector("input[name='f-name']").value.trim(),
            url: row.querySelector("input[name='f-url']").value.trim()
        })).filter(f => f.name && f.url);
        await setDoc(doc(db, "configs", "rss_sources"), { feeds }, { merge: true });
        showToast("âœ… RSSã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    };

    window.saveRootModel = async () => {
        const model = document.getElementById('root-model').value.trim();
        await setDoc(doc(db, "configs", "prompt"), { model }, { merge: true });
        showToast("âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    };

    window.saveList = async (key) => {
        const val = document.getElementById(`list-${key}`).value.split('\n').filter(l => l.trim());
        const d = {}; d[key] = val;
        await setDoc(doc(db, "configs", "prompt"), d, { merge: true });
        showToast(`âœ… ${key} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
    };

    window.savePrompt = async (name) => {
        const prompt = document.getElementById(`prompt-${name}`).value;
        const model = document.getElementById(`model-${name}`).value.trim();
        const temperature = parseFloat(document.getElementById(`temp-${name}`).value);
        const d = {}; d[name] = { prompt, model, temperature: isNaN(temperature) ? 0.2 : temperature };
        await setDoc(doc(db, "configs", "prompt"), d, { merge: true });
        showToast(`âœ… ${name} ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    };

    document.getElementById('saveConfigBtn').onclick = () => {
        const val = document.getElementById('configInput').value.trim();
        if (val) { localStorage.setItem('firebase_config', val); location.reload(); }
    };
    document.getElementById('statusBadge').onclick = () => {
        document.getElementById('configInput').value = localStorage.getItem('firebase_config') || "";
        modal.style.display = 'flex';
    };
    document.getElementById('closeModalBtn').onclick = () => modal.style.display = 'none';
    document.getElementById('searchBox').oninput = renderArticles;
    document.getElementById('topicOnly').onchange = renderArticles;

    // GCS Sync Trigger
    const syncButton = document.getElementById('execButton');
    if (syncButton) {
        syncButton.addEventListener('click', async () => {
            const url = 'https://deploy-news-html-23728484987.asia-northeast1.run.app';
            const resEl = document.getElementById('result');
            syncButton.disabled = true; syncButton.classList.add('opacity-50');
            resEl.innerText = 'RUNNING...'; resEl.className = 'text-[10px] font-bold text-blue-500 uppercase';

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trigger: 'manual_sync' }) });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                resEl.innerText = 'SUCCESS'; resEl.className = 'text-[10px] font-bold text-green-500 uppercase';
                showToast("âœ… GCSåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ");
            } catch (error) {
                resEl.innerText = 'FAILED'; resEl.className = 'text-[10px] font-bold text-red-500 uppercase';
                showToast("âŒ åŒæœŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                syncButton.disabled = false; syncButton.classList.remove('opacity-50');
            }
        });
    }

    initApp();
</script>
</body>
</html>